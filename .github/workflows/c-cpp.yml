name: Build Stable Non-JB iOS dylib

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Files (Clone)
        run: |
          mkdir -p build
          
          # 1. ØªØ­Ù…ÙŠÙ„ TinySTL (Ø§Ø³ØªØ®Ø¯Ø§Ù… git clone) ğŸ“¥
          echo "ğŸ“¥ Cloning TinySTL..."
          rm -rf TinySTL
          git clone --depth 1 https://github.com/kov4l3nko/TinySTL.git
          
          if [ -d "TinySTL" ]; then
            echo "âœ… TinySTL cloned."
          else
            echo "âŒ Failed to clone TinySTL."
            exit 1
          fi
          
          # 2. ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© fishhook
          curl -L -o fishhook.h https://raw.githubusercontent.com/facebook/fishhook/master/fishhook.h
          
          # 3. Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³Ø§Ø±Ø§Øª Dobby ÙŠØ¯ÙˆÙŠØ§Ù‹ (Ø­ÙŠØ« Ø£Ù†Ùƒ Ø±ÙØ¹Øª Ø§Ù„Ù…Ø¬Ù„Ø¯ Dobby Ù…Ø¨Ø§Ø´Ø±Ø©)
          if [ -d "Dobby" ]; then
             echo "ğŸ“‚ Dobby folder found."
          else
             echo "âŒ Dobby folder not found!"
             exit 1
          fi

          # 4. Ù†Ù‚Ù„ Ù…Ù„ÙØ§Øª TinySTL Ø¥Ù„Ù‰ Dobby ÙƒÙ…Ø§ ÙŠØªÙˆÙ‚Ø¹ Ø§Ù„Ù€ CMake
          mkdir -p Dobby/TINYSTL
          cp -r TinySTL/include/* Dobby/TINYSTL/
          
          # 5. Ø¥ØµÙ„Ø§Ø­Ø§Øª Pointer Arithmetic ÙÙŠ Dobby
          if [ -f "Dobby/source/Backend/UserMode/ExecMemory/clear-cache-tool-all.c" ]; then
            sed -i '' 's/sys_icache_invalidate(start, end - start);/sys_icache_invalidate((void *)start, (char *)end - (char *)start);/g' Dobby/source/Backend/UserMode/ExecMemory/clear-cache-tool-all.c
          fi
          
          # 6. Ø¥ØµÙ„Ø§Ø­ KittyMemory (Ø¥Ø°Ø§ ÙˆØ¬Ø¯)
          if [ -f "KittyMemory/KittyMemory.cpp" ]; then
            sed -i '' 's/sprintf(&buffer\[i \* 2\], "%02X", (unsigned char) temp\[i\]);/snprintf(\&buffer\[i \* 2\], 3, "%02X", (unsigned char) temp\[i\]);/g' KittyMemory/KittyMemory.cpp
          fi

      - name: Build with CMake (iOS) ğŸš€
        run: |
          # Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ØªØºÙŠØ±Ø§Øª Ø¨ÙŠØ¦Ø© Ø§Ù„Ù€ iOS
          SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)
          
          # Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ Dobby
          cd Dobby
          mkdir -p build
          cd build
          
          # Ø¥Ø¹Ø¯Ø§Ø¯ CMake Ù„Ù„Ù€ iOS
          cmake .. \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=$SDK_PATH \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_IOS_INSTALL_COMBINED=YES \
            -DCMAKE_BUILD_TYPE=Release \
            -DDOBBY_DEBUG=OFF \
            -DNearBranch=ON \
            -DPlugin.SymbolResolver=ON \
            -DBUILD_SHARED_LIBS=ON
            
          # Ø§Ù„Ø¨Ù†Ø§Ø¡
          make -j$(sysctl -n hw.ncpu)
          
          # Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ø§ØªØ¬
          cp libdobby.dylib ../../build/ShadowCheats.dylib

      - name: Upload Artifact ğŸ“¦
        uses: actions/upload-artifact@v4
        with:
          name: ShadowCheats_dylib
          path: build/ShadowCheats.dylib

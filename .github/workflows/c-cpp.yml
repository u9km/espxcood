name: Build Stable Non-JB iOS dylib

on:
  workflow_dispatch:
  push:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Files (Setup Dobby & Dependencies)
        run: |
          mkdir -p build
          
          # 1. ÙÙƒ Ø¶ØºØ· Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø¶ØºÙˆØ·Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª) ğŸ“¦
          if [ -f "esp.zip" ]; then unzip -q esp.zip; fi
          if [ -f "kittymemory.zip" ]; then unzip -q kittymemory.zip; fi
          if [ -f "sdk.zip" ]; then unzip -q sdk.zip; fi
          
          # 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¬Ù„Ø¯ Dobby (Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©) ğŸ“‚
          echo "ğŸ“‚ Checking for Dobby folder..."
          if [ -d "Dobby" ]; then
            echo "âœ… Dobby folder found."
          else
            echo "âŒ Dobby folder not found! Please ensure Dobby files are in a folder named 'Dobby' in the repository root."
            exit 1
          fi

          # 3. ØªØ­Ù…ÙŠÙ„ TinySTL (Ø§Ø³ØªØ®Ø¯Ø§Ù… curl Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† git clone Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡) ğŸ“¥
          echo "ğŸ“¥ Downloading TinySTL..."
          curl -L -o TinySTL.zip https://github.com/kov4l3nko/TinySTL/archive/refs/heads/master.zip
          unzip -q TinySTL.zip
          
          # 4. Ù†Ù‚Ù„ Ù…Ù„ÙØ§Øª TinySTL Ø¥Ù„Ù‰ Dobby ÙƒÙ…Ø§ ÙŠØªÙˆÙ‚Ø¹ Ø§Ù„Ù€ CMake
          mkdir -p Dobby/TINYSTL
          cp -r TinySTL-master/include/* Dobby/TINYSTL/
          
          # 5. ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© fishhook
          curl -L -o fishhook.h https://raw.githubusercontent.com/facebook/fishhook/master/fishhook.h
          # Ù†Ù‚Ù„ fishhook Ø¥Ù„Ù‰ Dobby
          mkdir -p Dobby/TINYSTL/fishhook
          cp fishhook.h Dobby/TINYSTL/fishhook/
          
          # 6. Ø¥ØµÙ„Ø§Ø­Ø§Øª Pointer Arithmetic ÙÙŠ Dobby
          if [ -f "Dobby/source/Backend/UserMode/ExecMemory/clear-cache-tool-all.c" ]; then
            sed -i '' 's/sys_icache_invalidate(start, end - start);/sys_icache_invalidate((void *)start, (char *)end - (char *)start);/g' Dobby/source/Backend/UserMode/ExecMemory/clear-cache-tool-all.c
          fi
          
          # 7. Ø¥ØµÙ„Ø§Ø­ KittyMemory (Ø¥Ø°Ø§ ÙˆØ¬Ø¯)
          if [ -f "KittyMemory/KittyMemory.cpp" ]; then
            sed -i '' 's/sprintf(&buffer\[i \* 2\], "%02X", (unsigned char) temp\[i\]);/snprintf(\&buffer\[i \* 2\], 3, "%02X", (unsigned char) temp\[i\]);/g' KittyMemory/KittyMemory.cpp
          fi

      - name: Build with CMake (iOS) ğŸš€
        run: |
          # Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ØªØºÙŠØ±Ø§Øª Ø¨ÙŠØ¦Ø© Ø§Ù„Ù€ iOS
          SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)
          
          # Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ Dobby
          cd Dobby
          mkdir -p build
          cd build
          
          # Ø¥Ø¹Ø¯Ø§Ø¯ CMake Ù„Ù„Ù€ iOS
          cmake .. \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=$SDK_PATH \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DDOBBY_DEBUG=OFF \
            -DNearBranch=ON \
            -DPlugin.SymbolResolver=ON \
            -DBUILD_SHARED_LIBS=ON
            
          # Ø§Ù„Ø¨Ù†Ø§Ø¡
          make -j$(sysctl -n hw.ncpu)
          
          # Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ø§ØªØ¬
          cp libdobby.dylib ../../build/ShadowCheats.dylib

      - name: Upload Artifact ğŸ“¦
        uses: actions/upload-artifact@v4
        with:
          name: ShadowCheats_dylib
          path: build/ShadowCheats.dylib
